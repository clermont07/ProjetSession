<?php
include_once("./crytage.php");

if (isset($_POST["connection"])){
    if (isset($_POST["pseudo"]) && isset($_POST["motDePasse"])){
        if($_POST["poste"] == "patient"){
            $msg = encryp($_POST['motDePasse']);
            $array = array("pseudo" => $_POST['pseudo'],"motDePasse" => $msg );
            $patient = new patient($array);
            $patientManager = new patientManager(connexion("bdd_hms"));
            $results = $patientManager->getPatientLog($patient);
        }
        if($_POST["poste"] == "employer"){
            $array = array("pseudo" => $_POST['pseudo']);
            $employer = new employer($array);
            $employerManager = new employerManager(connexion("bdd_hms"));
            $results = $employerManager->getEmployerLog($employer);
        }
        if($results != false){
            if(decryp($results->getMotDePasse())!= $_POST["motDePasse"]){
               $results = false;
            }
       }
        if ($results != false) 
        {
            $_SESSION['pseudo'] = $_POST['pseudo'];
            $_SESSION['motDePasse'] = $_POST['motDePasse'];

            if($_POST["poste"] == "patient"){
                $_SESSION['id'] = $results->getIdPatient();
                $_SESSION['idPoste'] = 0;
                header("Location:patient");
            }
            elseif($_POST["poste"] == "employer"){
                $_SESSION['id'] = $results->getIdEmployer();
                $_SESSION['idPoste'] = $results->getIdPoste();
                header("Location:profil");
            }
        }
        else{
            echo '<script>alert("Veuillez vous inscrire!")</script>';
        }
    }
}
?>

<div class="topnav">
    <a class="active" style="float:right" href="dashboard/projet/mvc/connection">Se connecter</a>
    <a class="active" style="float:right" href="dashboard/projet/mvc/inscription">Inscription</a>
    <a class="active" style="float:right" href="dashboard/projet/mvc/accueil">Accueil</a>
</div>

<center>
<div>
    <br><br><br><br>
    <form method="post">
        <h1 style=color:black>Connection</h1>
        <select name="poste" style="width:178px;">
        <option value="patient" selected>Patient</option>
        <option value="employer">Employer</option>
        </select><br><br>
        <input type="text" name="pseudo" placeholder="Pseudo" id="pseudo" minlength="6" maxlength='30' required><br><br>
        <input type="password" name="motDePasse" placeholder="Mot de passe" id="motDePasse" minlength="6" maxlength='30' required><br><br>
        <input type="submit" class="Buttons buttons" name="connection" value="Connecter"><br><br>
    </form>
</div>
<br><br><br><br><br><br><br><br><br><br><br><br>
</center>